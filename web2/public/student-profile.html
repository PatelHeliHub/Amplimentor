<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile - Amplimentor</title>
    <link rel="stylesheet" href="/style.css?v=1.3">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/student-dashboard.html" class="nav-brand">Amplimentor</a>
            <ul class="nav-menu">
                <li><a href="/student/profile">Profile</a></li>
                <li><a href="/student/mentors">Find Mentors</a></li>
                <li><a href="/chat.html">Chat</a></li>
                <li><a href="/chat-history.html">Chat History</a></li>
                <li><a href="/sessions.html">Sessions</a></li>
                <li><a href="/payment-history">Payment History</a></li>
                <li class="notification-item">
                    <a href="#" id="notificationLink"><i class="fas fa-bell"></i><span class="notification-count" id="notificationCount"></span></a>
                    <div class="notification-dropdown" id="notificationDropdown"></div>
                </li>
                <li><a href="/logout" class="logout-btn">Logout</a></li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <main>
            <section class="hero">
                <h1>My Student Profile</h1>
                <p class="hero-sub">Manage your personal information and academic details</p>
            </section>
            
            <section class="profile" id="student-profile-section">
                <div id="profile-view">
                    <div class="profile-info">
                        <div style="text-align: center;">
                            <img id="studentPhoto" src="/default-avatar.svg" style="border-radius: 50%; width: 120px; height: 120px; object-fit: cover; border: 4px solid #0077c2;" onerror="this.onerror=null;this.src='/default-avatar.svg'">
                            <h2 id="studentName">Student Name</h2>
                            <p><strong id="university"></strong></p>
                        </div>
                        <div>
                            <p><strong>Email:</strong> <span id="studentEmail"></span></p>
                            <p><strong>Standard:</strong> <span id="standard"></span></p>
                            <p><strong>Subjects:</strong> <span id="subjects"></span></p>
                            <p><strong>Date of Birth:</strong> <span id="dateOfBirth"></span></p>
                            <p><strong>Phone:</strong> <span id="phoneNumber"></span></p>
                        </div>
                    </div>
                    <div class="profile-section">
                        <h3>About Me</h3>
                        <p id="bio"></p>
                    </div>
                    <div class="profile-section">
                        <h3>Links</h3>
                        <p><strong>LinkedIn:</strong> <a id="linkedIn" href="#" target="_blank"></a></p>
                        <p><strong>GitHub:</strong> <a id="github" href="#" target="_blank"></a></p>
                    </div>
                    <div class="profile-section">
                        <h3>Goals & Preferences</h3>
                        <p><strong>Career Goals:</strong> <span id="careerGoals"></span></p>
                        <p><strong>Skills to Develop:</strong> <span id="skillsToDevelop"></span></p>
                        <p><strong>Meeting Frequency:</strong> <span id="meetingFrequency"></span></p>
                        <p><strong>Communication:</strong> <span id="communicationPreference"></span></p>
                    </div>
                    <div class="profile-actions">
                        <button id="editProfileBtn" class="cta-btn">Edit Profile</button>
                    </div>
                </div>

                <div id="profile-edit" style="display: none;">
                    <h3>Edit Your Profile</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label for="edit-name">Full Name</label>
                            <input type="text" id="edit-name" class="edit-input">
                        </div>
                        <div class="info-item">
                            <label for="edit-university">School / University</label>
                            <input type="text" id="edit-university" class="edit-input">
                        </div>
                        <div class="info-item">
                            <label for="edit-standard">Standard</label>
                            <select id="edit-standard" class="edit-input">
                                <option value="">Select...</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                        <div class="info-item">
                            <label for="edit-subjects">Subjects (comma-separated)</label>
                            <textarea id="edit-subjects" class="edit-input"></textarea>
                        </div>
                        <div class="info-item">
                            <label for="edit-dob">Date of Birth</label>
                            <input type="date" id="edit-dob" class="edit-input">
                        </div>
                        <div class="info-item">
                            <label for="edit-phone">Phone Number</label>
                            <input type="tel" id="edit-phone" class="edit-input">
                        </div>
                        <div class="info-item">
                            <label for="edit-bio">About Me</label>
                            <textarea id="edit-bio" class="edit-input" placeholder="Tell us a little about yourself..."></textarea>
                        </div>
                        <div class="info-item">
                            <label for="edit-linkedin">LinkedIn Profile URL</label>
                            <input type="url" id="edit-linkedin" class="edit-input" placeholder="https://linkedin.com/in/your-profile">
                        </div>
                        <div class="info-item">
                            <label for="edit-github">GitHub Profile URL</label>
                            <input type="url" id="edit-github" class="edit-input" placeholder="https://github.com/your-username">
                        </div>
                        <div class="info-item">
                            <label for="edit-careerGoals">Career Goals</label>
                            <textarea id="edit-careerGoals" class="edit-input"></textarea>
                        </div>
                        <div class="info-item">
                            <label for="edit-skillsToDevelop">Skills to Develop (comma-separated)</label>
                            <textarea id="edit-skillsToDevelop" class="edit-input"></textarea>
                        </div>
                        <div class="info-item">
                            <label for="edit-meetingFrequency">Preferred Meeting Frequency</label>
                            <select id="edit-meetingFrequency" class="edit-input">
                                <option value="">Select...</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-weekly">Bi-weekly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="info-item">
                            <label for="edit-communicationPreference">Preferred Communication</label>
                            <select id="edit-communicationPreference" class="edit-input">
                                <option value="">Select...</option>
                                <option value="Video Call">Video Call</option>
                                <option value="Chat">Chat</option>
                                <option value="Email">Email</option>
                            </select>
                        </div>
                         <div class="info-item">
                            <label for="edit-photo">Change Profile Photo</label>
                            <div class="photo-upload-container">
                                <input type="file" id="edit-photo" class="edit-input" accept="image/*">
                                <div class="photo-preview" id="photo-preview" style="display: none;">
                                    <img id="preview-image" src="" alt="Preview" style="max-width: 150px; max-height: 150px; border-radius: 50%; margin-top: 10px;">
                                    <button type="button" id="remove-photo" class="remove-photo-btn" style="margin-top: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Remove Photo</button>
                                </div>
                                <div class="upload-loading" id="upload-loading" style="display: none; text-align: center; margin-top: 10px;">
                                    <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #0077c2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <span style="margin-left: 10px; color: #0077c2;">Uploading photo...</span>
                                </div>
                                <div class="upload-info" style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                    Supported formats: JPG, PNG, GIF (max 5MB)
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button id="saveProfileBtn" class="cta-btn">Save Changes</button>
                        <button id="cancelEditBtn" class="cta-btn" style="background: #6c757d;">Cancel</button>
                    </div>
                </div>
            </section>
        </main>
        <footer>
            <p>&copy; 2025 Amplimentor. All rights reserved.</p>
        </footer>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const viewMode = document.getElementById('profile-view');
        const editMode = document.getElementById('profile-edit');
        
        function populateProfileData(student) {
            // Helper function to set text content
            const setText = (id, text) => document.getElementById(id).textContent = text || 'N/A';
            // Helper function to set href
            const setLink = (id, url) => {
                const el = document.getElementById(id);
                if (url) {
                    el.href = url;
                    el.textContent = url;
                    el.style.display = 'inline';
                } else {
                    el.style.display = 'none';
                    el.textContent = '';
                }
            };

            setText('studentName', student.name);
            setText('university', student.university);
            setText('studentEmail', student.email);
            setText('standard', student.standard);
            setText('subjects', (student.subjects && student.subjects.length) ? student.subjects.join(', ') : '');
            setText('dateOfBirth', student.dateOfBirth ? new Date(student.dateOfBirth).toLocaleDateString() : '');
            setText('phoneNumber', student.phoneNumber);
            setText('bio', student.bio);
            setLink('linkedIn', student.linkedIn);
            setLink('github', student.github);
            setText('careerGoals', student.careerGoals);
            setText('skillsToDevelop', (student.skillsToDevelop && student.skillsToDevelop.length) ? student.skillsToDevelop.join(', ') : '');
            setText('meetingFrequency', student.meetingFrequency);
            setText('communicationPreference', student.communicationPreference);
            
            const studentPhoto = document.getElementById('studentPhoto');
            if (student.photo) {
                studentPhoto.src = '/uploads/' + student.photo;
            } else {
                studentPhoto.src = '/default-avatar.svg';
            }

            // Populate edit form
            document.getElementById('edit-name').value = student.name || '';
            document.getElementById('edit-university').value = student.university || '';
            document.getElementById('edit-standard').value = student.standard || '';
            document.getElementById('edit-subjects').value = (student.subjects && student.subjects.length) ? student.subjects.join(', ') : '';
            document.getElementById('edit-dob').value = student.dateOfBirth ? new Date(student.dateOfBirth).toISOString().split('T')[0] : '';
            document.getElementById('edit-phone').value = student.phoneNumber || '';
            document.getElementById('edit-bio').value = student.bio || '';
            document.getElementById('edit-linkedin').value = student.linkedIn || '';
            document.getElementById('edit-github').value = student.github || '';
            document.getElementById('edit-careerGoals').value = student.careerGoals || '';
            document.getElementById('edit-skillsToDevelop').value = (student.skillsToDevelop && student.skillsToDevelop.length) ? student.skillsToDevelop.join(', ') : '';
            document.getElementById('edit-meetingFrequency').value = student.meetingFrequency || '';
            document.getElementById('edit-communicationPreference').value = student.communicationPreference || '';
        }

        function fetchStudentProfile() {
            fetch('/api/student/profile', { credentials: 'include' })
                .then(res => res.ok ? res.json() : Promise.reject('Failed to load profile'))
                .then(populateProfileData)
                .catch(console.error);
        }

        document.getElementById('editProfileBtn').addEventListener('click', () => {
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            editMode.style.display = 'none';
            viewMode.style.display = 'block';
        });

        document.getElementById('saveProfileBtn').addEventListener('click', () => {
            const updatedData = {
                name: document.getElementById('edit-name').value,
                university: document.getElementById('edit-university').value,
                standard: document.getElementById('edit-standard').value,
                subjects: document.getElementById('edit-subjects').value.split(',').map(s => s.trim()).filter(Boolean),
                dateOfBirth: document.getElementById('edit-dob').value,
                phoneNumber: document.getElementById('edit-phone').value,
                bio: document.getElementById('edit-bio').value,
                linkedIn: document.getElementById('edit-linkedin').value,
                github: document.getElementById('edit-github').value,
                careerGoals: document.getElementById('edit-careerGoals').value,
                skillsToDevelop: document.getElementById('edit-skillsToDevelop').value.split(',').map(s => s.trim()).filter(Boolean),
                meetingFrequency: document.getElementById('edit-meetingFrequency').value,
                communicationPreference: document.getElementById('edit-communicationPreference').value,
            };

            const photoFile = document.getElementById('edit-photo').files[0];

            const saveProfileData = () => {
                fetch('/api/student/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(updatedData),
                })
                .then(res => res.ok ? res.json() : Promise.reject('Failed to save profile data'))
                .then(() => {
                    editMode.style.display = 'none';
                    viewMode.style.display = 'block';
                    fetchStudentProfile(); // Refresh data
                    // Clear photo preview
                    document.getElementById('photo-preview').style.display = 'none';
                    document.getElementById('edit-photo').value = '';
                })
                .catch(error => {
                    console.error('Error saving profile:', error);
                    alert('Failed to save profile. Please try again.');
                });
            };

            if (photoFile) {
                // Validate file size
                if (photoFile.size > 5 * 1024 * 1024) {
                    alert('File size too large. Maximum size is 5MB.');
                    return;
                }

                // Validate file type
                if (!photoFile.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }

                // Show loading indicator
                document.getElementById('upload-loading').style.display = 'block';
                document.getElementById('saveProfileBtn').disabled = true;
                document.getElementById('saveProfileBtn').textContent = 'Uploading...';

                const formData = new FormData();
                formData.append('photo', photoFile);
                fetch('/api/student/upload-photo', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData,
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(err => Promise.reject(err.message || 'Photo upload failed'));
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Photo uploaded successfully:', data);
                    // Hide loading indicator
                    document.getElementById('upload-loading').style.display = 'none';
                    document.getElementById('saveProfileBtn').disabled = false;
                    document.getElementById('saveProfileBtn').textContent = 'Save Changes';
                    saveProfileData();
                })
                .catch(error => {
                    console.error('Photo upload error:', error);
                    // Hide loading indicator
                    document.getElementById('upload-loading').style.display = 'none';
                    document.getElementById('saveProfileBtn').disabled = false;
                    document.getElementById('saveProfileBtn').textContent = 'Save Changes';
                    alert('Failed to upload photo: ' + error);
                });
            } else {
                saveProfileData();
            }
        });

        // Photo preview functionality
        document.getElementById('edit-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('photo-preview');
            const previewImage = document.getElementById('preview-image');
            
            if (file) {
                // Validate file size
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Maximum size is 5MB.');
                    this.value = '';
                    preview.style.display = 'none';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    this.value = '';
                    preview.style.display = 'none';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        // Remove photo functionality
        document.getElementById('remove-photo').addEventListener('click', function() {
            document.getElementById('edit-photo').value = '';
            document.getElementById('photo-preview').style.display = 'none';
        });

        fetchStudentProfile();
    });
    </script>
</body>
</html>